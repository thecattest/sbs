<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Регистрация</title>
  <link rel="stylesheet" href="frontend/css/bootstrap.min.css">
  <link rel="stylesheet" href="frontend/css/style.css">
  <script src="frontend/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <!--script src="https://cdn.jsdelivr.net/npm/vue@2"></script>-->
</head>
<body>
  <div class="container my-4">
    <h2 class="mx-3 my-2">Регистрация</h2>
    <div class="container py-3" id="app">
      <div class="row justify-content-center">
        <div class="card col-xs-12 col-sm-8 col-md-6 col-lg-5">
          <div class="mb-3">
            <label for="phone" class="form-label">Номер телефона</label>
            <div class="input-group input-group-sm-">
              <div class="input-group-text">+7</div>
              <input type="text" class="form-control form-control-sm-" id="phone" autofocus
                placeholder="9001203040" v-model="phone"
              >
            </div>
            <small class="invalid" v-show="phoneMsg">{{ phoneMsg }}</small>
          </div>
          <div class="mb-3">
            <label for="surname" class="form-label">Фамилия</label>
              <input type="text" class="form-control form-control-sm-" id="surname"
                placeholder="Федотов" v-model="surname"
              >
              <small class="invalid" v-show="surnameMsg">{{ surnameMsg }}</small>
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">Имя</label>
              <input type="text" class="form-control form-control-sm-" id="name"
                placeholder="Иван" v-model="name"
              >
              <small class="invalid" v-show="nameMsg">{{ nameMsg }}</small>
          </div>
          <div class="mb-3">
            <label for="secondname" class="form-label">Отчество</label>
              <input type="text" class="form-control form-control-sm-" id="secondname"
                placeholder="Игоревич" v-model="secondname" @keyup.enter="register"
              >
              <small class="invalid" v-show="secondnameMsg">{{ secondnameMsg }}</small>
          </div>
          <div class="d-flex justify-content-end">
            <div class="d-flex align-items-center">
              <button type="button" class="btn btn-success btn-sm" :disabled="registerDisabled" @click="register"
              >Зарегистрироваться</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

<script>
  app = new Vue({
    el: "#app",
    data: {
      phone: undefined,
      surname: undefined,
      name: undefined,
      secondname: undefined,
      phoneMsg: '',
      surnameMsg: '',
      nameMsg: '',
      secondnameMsg: ''
    },
    methods: {
      register: function() {
        vm = this;
        axios.post('/api/register', {'phone': this.phone, 'surname': this.surname, 'name': this.name, 'secondname': this.secondname})
          .then(response => {
            const status = response.status
            if (status == 201) {
              window.location.replace('login');
            }
          })
          .catch(error => {
            vm.handleResponseError(error);
            if (error.response.status == 409)
              this.phoneMsg = 'аккаунт с таким номером уже существует';
          });
      },
      handleResponseError: function (error) {
        console.log(error.toJSON());
        console.log(error.response.data);
      }
    },
    watch: {
      phone: function() {
        this.phoneMsg = '';
        p = this.phone;
        p = p.replaceAll(/[^\d]/g, '');
        if (p[0] == '7') p = p.substring(1);
        if (p[0] == '8') p = p.substring(1);
        p = p.substring(0, 10);
        if (p.length > 3) p = p.substring(0, 3) + ' ' + p.substring(3);
        if (p.length > 7) p = p.substring(0, 7) + ' ' + p.substring(7);
        if (p.length > 10) p = p.substring(0, 10) + ' ' + p.substring(10);
        this.phone = p;
      },
      surname: function() {
        this.surnameMsg = '';
        s = this.surname;
        s = s.replaceAll(/[^а-яА-я\-]/g, '');
        this.surname = s.substr(0, 30);
      },
      name: function() {
        this.nameMsg = '';
        n = this.name;
        n = n.replaceAll(/[^а-яА-я\-]/g, '');
        this.name = n.substr(0, 30);
      },
      secondname: function() {
        this.secondnameMsg = '';
        sn = this.secondname;
        sn = sn.replaceAll(/[^а-яА-я\-]/g, '');
        this.secondname = sn.substr(0, 30);
      }
    },
    computed: {
      registerDisabled: function() {
        return !(this.phone && this.phone.length == 13 && this.surname && this.name && this.secondname);
      }
    },
    created() {

    }
  });
</script>
